---
title: "Tattersalls"
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(rBloodstock)
data(tatts_2010, tatts_2011, tatts_2012, tatts_2013, tatts_2014)
```
There are currently (as of `r Sys.Date()`) 5 datasets with Tattersalls sales data, these are:

Name | Sales included | Dim
-----|----------------|-----
tatts_2010 | <sub>`r paste(unique(tatts_2010$sale), collapse = ", ")`</sub> | `r dim(tatts_2010)[1]` rows, 12 cols
tatts_2011 | <sub>`r paste(unique(tatts_2011$sale), collapse = ", ")`</sub> | `r dim(tatts_2011)[1]` rows, 12 cols
tatts_2012 | <sub>`r paste(unique(tatts_2012$sale), collapse = ", ")`</sub> | `r dim(tatts_2012)[1]` rows, 12 cols
tatts_2013 | <sub>`r paste(unique(tatts_2013$sale), collapse = ", ")`</sub> | `r dim(tatts_2013)[1]` rows, 12 cols
tatts_2014 | <sub>`r paste(unique(tatts_2014$sale), collapse = ", ")`</sub> | `r dim(tatts_2014)[1]` rows, 12 cols

There is a function to collect data from sales not included in the package, see [here](collect_tatts_sales.html).

To load a dataset:
```{r}
data(tatts_2010)
```

Each of the 5 datasets have the same 12 variables, ``r names(tatts_2010)``, as can be seen in the table above, the same sales take place each year.  

### Some Analysis

It is easy to combine the 5 datasets, such as:
```{r}
data(tatts_2010, tatts_2011, tatts_2012, tatts_2013, tatts_2014)

# combine all 5 datasets into one large dataset
tattersalls <- rbind(tatts_2010, tatts_2011, tatts_2012, tatts_2013, tatts_2014)
# clean workspace
rm(tatts_2010, tatts_2011, tatts_2012, tatts_2013, tatts_2014)
```

The new `tattersalls` dataset has `r dim(tattersalls)[1]` rows and `r dim(tattersalls)[2]` columns, the `sale_name` variable can serve as an individual sale (so it includes the year of the sale, eg. **`r head(tattersalls$sale_name, 1)`**), while the `sale` variable will match across multiple years.

Loading other libraries `dplyr` and `ggplot2` we can quickly analyse data:
```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
```

The average price of lots in each sale across multiple years:

```{r fig.align='center', fig.height=5, fig.width=9}
sale_summaries <- tattersalls %>%
    group_by(sale, year) %>%
    summarise(n = n(),
              mean = mean(price, na.rm=T))

ggplot(sale_summaries, aes(x=year, y=mean)) +
    geom_bar(stat="identity", fill="#D9220F") +
    theme_bw() +
    theme(text = element_text(size=10)) +
    facet_wrap(~sale)
```

One thing stands out immediately from the plots above, don't go to October Book 1 unless you have deep pockets, the average price paid has more than doubled from 96,001 Guineas in 2010 to 212,637 Guineas in 2014.  October Book 2 has also (unsurprisingly) seen a small increase in average price paid over the same period.  The Craven sale has also seen a small increase over recent years, but prices are in other sales appear to be quite consistent.

We can also find the 20 sires with the highest average price over the 5 years:

```{r}
tattersalls %>%
    group_by(sire) %>%
    summarise(n = n(),
              mean = mean(price, na.rm=T),
              sd = sd(price, na.rm=T),
              min = min(price, na.rm=T),
              max = max(price, na.rm=T)) %>%
    filter(n >= 50) %>%
    arrange(desc(mean)) %>%
    head(20)
```

**Sea The Stars** is top of the list, his progeny costing a cool 224,100 Guineas on average, Galileo is a very close second, with a large drop down, of almost 100,000 Guineas, to Danehill.  Perhaps more interesting than Sea The Stars topping Galileo is the *standard deviation* of their prices, Sea The Stars with a much smaller **sd** perhaps suggests buyers believe his progeny will prove to be successful (see Taghrooda), but are still showing some restraint and aren't quite willing to part with the big sums seen with Galileo, whose most expensive sale fetched 9 times the most expensive Sea The Stars sale.

It's also possible to look at the buyers or agents with the highest average price paid over the 5years.
```{r}
tattersalls %>%
    group_by(buyer) %>%
    summarise(n = n(),
              mean = mean(price, na.rm=T),
              sd = sd(price, na.rm=T),
              min = min(price, na.rm=T),
              max = max(price, na.rm=T)) %>%
    filter(n >= 50) %>%
    arrange(desc(mean)) %>%
    head(20)
```

Demi O'Byrne (an agent associated with Coolmore) isn't as active as others in the top 5, with just 50 purchases, but the average price he pays is almost double that of John Ferguson (links with Godolphin).